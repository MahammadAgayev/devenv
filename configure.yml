- hosts: localhost
  vars:
    devenv_dir: "{{ ansible_env.HOME }}/devenv"
    zsh_custom: "{{ lookup('env', 'ZSH_CUSTOM') | default(ansible_env.HOME + '/.oh-my-zsh/custom', true) }}"

  tasks:
    # ─── System packages ──────────────────────────────────────────────────────

    - name: Install packages (Debian/RedHat)
      apt:
        name: ["zsh", "git", "tmux", "fzf", "curl", "neovim"]
        state: present
        update_cache: true
      become: true
      when: ansible_facts['os_family'] in ["Debian", "RedHat"]

    # - name: Install packages (macOS)
    #   community.general.homebrew:
    #     name: ["zsh", "git", "tmux", "fzf", "curl", "neovim"]
    #     state: present
    #   when: ansible_facts['system'] == "Darwin"

    # ─── Claude Code ──────────────────────────────────────────────────────────

    - name: Check if Claude Code is installed
      stat:
        path: "{{ ansible_env.HOME }}/.local/bin/claude"
      register: claude_status

    - name: Install Claude Code
      shell: curl -fsSL https://claude.ai/install.sh | bash
      args:
        executable: /bin/bash
      when: not claude_status.stat.exists

    # ─── Directories ──────────────────────────────────────────────────────────

    - name: Ensure home directories exist
      file:
        path: "{{ ansible_env.HOME }}/{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - debug
        - any
        - src
        - .config

    # ─── Shell ────────────────────────────────────────────────────────────────

    - name: Get current shell
      command: getent passwd {{ ansible_user_id }}
      register: passwd_entry
      changed_when: false

    - name: Change default shell to zsh
      ansible.builtin.user:
        name: "{{ ansible_user_id }}"
        shell: "{{ ansible_env.SHELL | default('/usr/bin/zsh') }}"
      become: true
      when: passwd_entry.stdout is not search('/zsh')

    # ─── Oh My Zsh ────────────────────────────────────────────────────────────

    - name: Check if Oh My Zsh is installed
      stat:
        path: "{{ ansible_env.HOME }}/.oh-my-zsh"
      register: omz_status

    - name: Install Oh My Zsh
      shell: |
        curl -fsSL https://raw.github.com/ohmyzsh/ohmyzsh/master/tools/install.sh | sh -s -- --unattended
      args:
        executable: /bin/bash
      when: not omz_status.stat.exists

    - name: Install Powerlevel10k theme
      ansible.builtin.git:
        repo: https://github.com/romkatv/powerlevel10k.git
        dest: "{{ zsh_custom }}/themes/powerlevel10k"
        depth: 1
        update: false

    - name: Install zsh-autosuggestions plugin
      ansible.builtin.git:
        repo: https://github.com/zsh-users/zsh-autosuggestions.git
        dest: "{{ ansible_env.HOME }}/.oh-my-zsh/plugins/zsh-autosuggestions"
        update: false

    # ─── Devenv repo ──────────────────────────────────────────────────────────

    - name: Clone devenv repository
      ansible.builtin.git:
        repo: https://github.com/MahammadAgayev/devenv.git
        dest: "{{ devenv_dir }}"
        update: false   # don't overwrite local changes; run git pull manually

    # ─── Dotfile symlinks ─────────────────────────────────────────────────────

    - name: Symlink dotfiles into HOME
      file:
        src: "{{ devenv_dir }}/{{ item.src }}"
        dest: "{{ ansible_env.HOME }}/{{ item.dest }}"
        state: link
        force: true
      loop:
        - { src: ".zshrc",           dest: ".zshrc"           }
        - { src: ".p10k.zsh",        dest: ".p10k.zsh"        }
        - { src: ".tmux.conf",       dest: ".tmux.conf"       }
        - { src: "tmux-sessionizer", dest: "tmux-sessionizer" }

    - name: Ensure tmux-sessionizer is executable
      file:
        path: "{{ ansible_env.HOME }}/tmux-sessionizer"
        mode: '0755'

    - name: Symlink Neovim config
      file:
        src: "{{ devenv_dir }}/nvim"
        dest: "{{ ansible_env.HOME }}/.config/nvim"
        state: link
        force: true

    # ─── Optional: go-code envrc ──────────────────────────────────────────────

    - name: Check if ~/go-code directory exists
      stat:
        path: "{{ ansible_env.HOME }}/go-code"
      register: gocode_status

    - name: Symlink go-code envrc
      file:
        src: "{{ devenv_dir }}/.gomonorepo.envrc.local"
        dest: "{{ ansible_env.HOME }}/go-code/.envrc.local"
        state: link
        force: true
      when: gocode_status.stat.exists
